---
title: iOSå¤šçº¿ç¨‹
date: 2017-11-21 15:34:43
tags:
	- åŸºç¡€çŸ¥è¯†
categories:
	- åŸºç¡€çŸ¥è¯†
---

# iOSå¼€å‘å¤šçº¿ç¨‹

é¦–å…ˆæˆ‘ä»¬æ¥ææ¸…æ¥šå‡ ä¸ªæ¦‚å¿µå’Œä»–ä»¬ä¹‹é—´çš„è”ç³»å’ŒåŒºåˆ«: 

## å¤šçº¿ç¨‹å¼€å‘å¸¸ç”¨æ¦‚å¿µ

1.  è¿›ç¨‹å’Œçº¿ç¨‹

    è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºå…³äºæŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨, è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½. 
    â€‹	
    çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“, æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾(èµ„æºåˆ†é…)çš„åŸºæœ¬å•ä½, å®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½. çº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æº, åªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æº(å¦‚ç¨‹åºè®¡æ•°å™¨, ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆ), ä½†æ˜¯å®ƒå¯ä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æº. 

    ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åˆ›å»ºå’Œæ’¤é”€å¦ä¸€ä¸ªçº¿ç¨‹; åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯ä»¥å¹¶å‘æ‰§è¡Œ. 

    è¿›ç¨‹å’Œçº¿ç¨‹çš„ä¸»è¦å·®åˆ«åœ¨äºå®ƒä»¬æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿèµ„æºç®¡ç†æ–¹å¼. è¿›ç¨‹æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´, ä¸€ä¸ªè¿›ç¨‹å´©æºƒå, åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹äº§ç”Ÿå½±å“. è€Œçº¿ç¨‹åªæ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒæ‰§è¡Œè·¯å¾„. çº¿ç¨‹æœ‰è‡ªå·±çš„å †æ ˆå’Œå±€éƒ¨å˜é‡, ä½†çº¿ç¨‹ä¹‹é—´æ²¡æœ‰å•ç‹¬çš„åœ°å€ç©ºé—´, ä¸€ä¸ªçº¿ç¨‹æ­»æ‰å°±ç­‰äºæ•´ä¸ªè¿›ç¨‹æ­»æ‰, æ‰€ä»¥å¤šè¿›ç¨‹çš„ç¨‹åºè¦æ¯”å¤šçº¿ç¨‹çš„ç¨‹åºå¥å£®, ä½†åœ¨è¿›ç¨‹åˆ‡æ¢æ—¶, è€—è´¹èµ„æºè¾ƒå¤§, æ•ˆç‡è¦å·®ä¸€äº›. ä½†å¯¹äºä¸€äº›è¦æ±‚åŒæ—¶è¿›è¡Œå¹¶ä¸”åˆè¦å…±äº«æŸäº›å˜é‡çš„å¹¶å‘æ“ä½œ, åªèƒ½ç”¨çº¿ç¨‹, ä¸èƒ½ç”¨è¿›ç¨‹. 

    1. ç®€è€Œè¨€ä¹‹, ä¸€ä¸ªç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªè¿›ç¨‹, ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹.
       2. çº¿ç¨‹çš„åˆ’åˆ†å°ºåº¦å°äºè¿›ç¨‹, ä½¿å¾—å¤šçº¿ç¨‹ç¨‹åºçš„å¹¶å‘æ€§é«˜. 
       3. å¦å¤–, è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜å•å…ƒ, è€Œå¤šä¸ªçº¿ç¨‹å…±äº«å†…å­˜, ä»è€Œæå¤§åœ°æé«˜äº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡. 
       4. çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¿›ç¨‹è¿˜æ˜¯æœ‰åŒºåˆ«çš„. æ¯ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å…¥å£, é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºçš„å‡ºå£. ä½†æ˜¯çº¿ç¨‹ä¸èƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œ, å¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­, ç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶. 
       5. ä»é€»è¾‘è§’åº¦æ¥çœ‹, å¤šçº¿ç¨‹çš„æ„ä¹‰åœ¨äºä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­, æœ‰å¤šä¸ªæ‰§è¡Œéƒ¨åˆ†å¯ä»¥åŒæ—¶æ‰§è¡Œ. ä½†æ“ä½œç³»ç»Ÿå¹¶æ²¡æœ‰å°†å¤šä¸ªçº¿ç¨‹çœ‹åšå¤šä¸ªç‹¬ç«‹çš„åº”ç”¨, æ¥å®ç°è¿›ç¨‹çš„è°ƒåº¦å’Œç®¡ç†ä»¥åŠèµ„æºåˆ†é…. è¿™å°±æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹çš„é‡è¦åŒºåˆ«.

    æ‰“ä¸ªæ¯”æ–¹, å¤šè¿›ç¨‹å°±å¥½æ¯”åŒæ—¶æ‰§è¡Œå¤šä¸ªç¨‹åº. æ¯”å¦‚åŒæ—¶è¿è¡ŒQQ, éŸ³ä¹æ’­æ”¾å™¨, ä»¥åŠæµè§ˆå™¨. å¤šçº¿ç¨‹å°±æ˜¯åŒä¸€æ—¶åˆ»æ‰§è¡Œå¤šä¸ªçº¿ç¨‹, ç”¨æµè§ˆå™¨ä¸€è¾¹ä¸‹è½½, ä¸€è¾¹å¬æ­Œ, ä¸€è¾¹çœ‹è§†é¢‘, ä¸€è¾¹çœ‹ç½‘é¡µ. æµè§ˆå™¨è¿™ä¸ªè¿›ç¨‹ä¸‹æœ‰å¤šä¸ªçº¿ç¨‹, è¿™äº›çº¿ç¨‹å…±äº«ç³»ç»Ÿåˆ†é…ç»™æµè§ˆå™¨è¿™ä¸ªè¿›ç¨‹çš„èµ„æº, æ‰€ä»¥å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯å¾ˆæ–¹ä¾¿çš„é€šä¿¡, ä¸€ä¸ªçº¿ç¨‹æ­»äº†, ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œ. å¦‚æœæµè§ˆå™¨è¿™ä¸ªè¿›ç¨‹æ­»äº†, é‚£ä¹ˆä»–ä¸‹é¢çš„æ‰€æœ‰çº¿ç¨‹å°±éƒ½ç”¨ä¸äº†äº†. æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€QQè¿™é‡Œå°±æ˜¯è¿›ç¨‹é—´é€šä¿¡, ç”±äºä¸åŒçš„è¿›ç¨‹ç³»ç»Ÿèµ„æºä¸åŒ, æ‰€ä»¥è¿›ç¨‹é—´çš„é€šä¿¡ä¸æ˜¯å¾ˆå®¹æ˜“å®ç°. å¹¶ä¸”åˆ‡æ¢è¿›ç¨‹ä¼šæœ‰æ€§èƒ½é—®é¢˜.

2.  å¹¶å‘å’Œå¹¶è¡Œ

     å¹¶å‘æŒ‡èƒ½å¤Ÿè®©å¤šä¸ªä»»åŠ¡åœ¨é€»è¾‘ä¸Šäº¤ç»‡æ‰§è¡Œçš„ç¨‹åºè®¾è®¡, ä½†å¹¶å‘äº‹ä»¶ä¹‹é—´ä¸ä¸€å®šè¦åŒä¸€æ—¶åˆ»å‘ç”Ÿ. å¹¶è¡ŒæŒ‡çš„æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„çŠ¶æ€æ˜¯ç‰©ç†ä¸ŠåŒæ—¶æ‰§è¡Œ, æ˜¯æŒ‡åŒæ—¶å‘ç”Ÿçš„ä¸¤ä¸ªå¹¶å‘äº‹ä»¶, å…·æœ‰å¹¶å‘çš„å«ä¹‰, è€Œå¹¶å‘åˆ™ä¸ä¸€å®šå¹¶è¡Œ. 

     å¹¶å‘æ˜¯ä¸€ç§ç°è±¡, é¢å¯¹è¿™ä¸€ç°è±¡, æˆ‘ä»¬é¦–å…ˆåˆ›å»ºå¤šä¸ªçº¿ç¨‹. çœŸæ­£åŠ å¿«ç¨‹åºè¿è¡Œé€Ÿåº¦çš„, æ˜¯å¹¶è¡ŒæŠ€æœ¯. ä¹Ÿå°±æ˜¯è®©å¤šä¸ªCPUåŒæ—¶å·¥ä½œ. è€Œå¤šçº¿ç¨‹, æ˜¯ä¸ºäº†è®©å¤šä¸ªCPUåŒæ—¶å·¥ä½œæˆä¸ºå¯èƒ½. å¹¶å‘è®¾è®¡è®©å¹¶å‘æ‰§è¡Œæˆä¸ºå¯èƒ½, è€Œå¹¶è¡Œæ˜¯å¹¶å‘æ‰§è¡Œçš„ä¸€ç§æ¨¡å¼.

     å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªäººåŒæ—¶åƒä¸‰ä¸ªé¦’å¤´å’Œä¸‰ä¸ªäººåŒæ—¶åƒä¸‰ä¸ªé¦’å¤´. ä¸€ä¸ªäººåŒæ—¶åƒä¸‰ä¸ªé¦’å¤´ä½†æ˜¯åŒä¸€æ—¶é—´åªèƒ½å•ƒä¸€ä¸ªé¦’å¤´, ä¸‰ä¸ªäººåŒæ—¶åƒä¸‰ä¸ªé¦’å¤´, ä¸‰ä¸ªé¦’å¤´åŒä¸€æ—¶é—´éƒ½ä¼šè¢«å•ƒ.

     ä¸‹å›¾åæ˜ äº†ä¸€ä¸ªåŒ…å«8ä¸ªæ“ä½œçš„ä»»åŠ¡åœ¨ä¸€ä¸ªæœ‰ä¸¤æ ¸å¿ƒçš„CPUä¸­åˆ›å»ºå››ä¸ªçº¿ç¨‹è¿è¡Œçš„æƒ…å†µ. å‡è®¾æ¯ä¸ªæ ¸å¿ƒæœ‰ä¸¤ä¸ªçº¿ç¨‹, é‚£ä¹ˆæ¯ä¸ªCPUä¸­ä¸¤ä¸ªçº¿ç¨‹ä¼šäº¤æ›¿å¹¶å‘, ä¸¤ä¸ªCPUä¹‹é—´çš„æ“ä½œä¼šå¹¶è¡Œè¿ç®—. å°±CPU1è€Œè¨€è™½ç„¶å®ç°äº†å¹¶å‘ä½†æ˜¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è¿›è¡Œ, CPUåªæ˜¯å¿«é€Ÿçš„åœ¨ä»»åŠ¡ä¹‹é—´åˆ‡æ¢, CPU1å’ŒCPU2æ•´ä½“æ¥çœ‹æ˜¯å¹¶è¡Œå…ƒç®—, åŒä¸€æ—¶é—´æ˜¯æœ‰å¤šä¸ªä»»åŠ¡åœ¨è¿›è¡Œ. å•å°±ä¸€ä¸ªCPUè€Œè¨€ä¸¤ä¸ªçº¿ç¨‹å¯ä»¥è§£å†³çº¿ç¨‹é˜»å¡é€ æˆçš„ä¸æµç•…é—®é¢˜, å…¶æœ¬èº«è¿è¡Œæ•ˆç‡å¹¶æ²¡æœ‰æé«˜. å¤šCPUçš„å¹¶è¡Œè¿ç®—æ‰çœŸæ­£è§£å†³äº†è¿è¡Œæ•ˆç‡é—®é¢˜, è¿™ä¹Ÿæ­£æ˜¯å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«. 

     ![å¹¶å‘å’Œå¹¶è¡Œ](http://img.souche.com/f2e/5d7717afde012bbfc557f26bc5eaffea.png)

     æ³¨æ„: å¹¶è¡Œå’Œä¸²è¡Œæ˜¯ç›¸å¯¹åº”çš„. ä¸²è¡Œåœ¨ç‰©ç†å±‚é¢ä¸ŠåŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è¿›è¡Œ.

3.  åŒæ­¥å’Œå¼‚æ­¥

     åŒæ­¥åœ¨å‘å‡ºä¸€ä¸ªåŒæ­¥è°ƒç”¨æ—¶, åœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰, è¯¥è°ƒç”¨å°±ä¸è¿”å›. å¤šä¸ªä»»åŠ¡æƒ…å†µä¸‹, ä¸€ä¸ªä»»åŠ¡Aæ‰§è¡Œç»“æŸ, æ‰å¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡B. åªå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹. å¼‚æ­¥åœ¨å‘å‡ºä¸€ä¸ªå¼‚æ­¥è°ƒç”¨å, è°ƒç”¨è€…ä¸ä¼šç«‹åˆ»å¾—åˆ°ç»“æœ, è¯¥è°ƒç”¨å°±è¿”å›äº†. å¤šä¸ªä»»åŠ¡æƒ…å†µä¸‹, ä¸€ä¸ªä»»åŠ¡Aæ­£åœ¨æ‰§è¡Œ, åŒæ—¶å¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡B. ä»»åŠ¡Bä¸ç”¨ç­‰å¾…ä»»åŠ¡Aç»“æŸæ‰æ‰§è¡Œ. å­˜åœ¨å¤šæ¡çº¿ç¨‹. 

## å¤šçº¿ç¨‹å®ç°æ–¹æ¡ˆ

åœ¨iOSå¼€å‘ä¸­å¸¸è§çš„å¤šçº¿ç¨‹æ–¹æ¡ˆä¸€å…±æœ‰4å¥—, åˆ†åˆ«æ˜¯`Pthreads`, `NSThread`, `GCD`, `NSOperation & NSOperationQueue`. å‰ä¸¤ç§ä¸æ€ä¹ˆå¸¸ç”¨, è¿™é‡Œå°±ç®€å•çš„ä»‹ç»ä¸€ä¸‹, ç€é‡ä»‹ç»åä¸¤ç§. 

### Pthresds

POSIXçº¿ç¨‹(POSIX threads), ç®€ç§°Pthreads, æ˜¯çº¿ç¨‹çš„POSIXæ ‡å‡†. è¯¥æ ‡å‡†å®šä¹‰äº†åˆ›å»ºå’Œæ“çºµçº¿ç¨‹çš„ä¸€æ•´å¥—API, åœ¨ç±»Unixæ“ä½œç³»ç»Ÿ(Unixã€Linuxã€Mac OSXç­‰)ä¸­, éƒ½ä½¿ç”¨Pthreadsä½œä¸ºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹. é‚£ä¹Ÿå°±æ„å‘³ç€å¯ä»¥è·¨å¹³å°ä½¿ç”¨, ä½†æ˜¯ä½¿ç”¨èµ·æ¥ç‰¹åˆ«é…¸çˆ½. ğŸ™‚

```
#import <pthread.h>

- (void)pthreadsDoTask {
    /*
     pthread_tï¼šçº¿ç¨‹æŒ‡é’ˆ
     pthread_attr_tï¼šçº¿ç¨‹å±æ€§
     pthread_mutex_tï¼šäº’æ–¥å¯¹è±¡
     pthread_mutexattr_tï¼šäº’æ–¥å±æ€§å¯¹è±¡
     pthread_cond_tï¼šæ¡ä»¶å˜é‡
     pthread_condattr_tï¼šæ¡ä»¶å±æ€§å¯¹è±¡
     pthread_key_tï¼šçº¿ç¨‹æ•°æ®é”®
     pthread_rwlock_tï¼šè¯»å†™é”
     //
     pthread_create()ï¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹
     pthread_exit()ï¼šç»ˆæ­¢å½“å‰çº¿ç¨‹
     pthread_cancel()ï¼šä¸­æ–­å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ
     pthread_join()ï¼šé˜»å¡å½“å‰çš„çº¿ç¨‹, ç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿è¡Œç»“æŸ
     pthread_attr_init()ï¼šåˆå§‹åŒ–çº¿ç¨‹çš„å±æ€§
     pthread_attr_setdetachstate()ï¼šè®¾ç½®è„±ç¦»çŠ¶æ€çš„å±æ€§ï¼ˆå†³å®šè¿™ä¸ªçº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æ˜¯å¦å¯ä»¥è¢«ç»“åˆï¼‰
     pthread_attr_getdetachstate()ï¼šè·å–è„±ç¦»çŠ¶æ€çš„å±æ€§
     pthread_attr_destroy()ï¼šåˆ é™¤çº¿ç¨‹çš„å±æ€§
     pthread_kill()ï¼šå‘çº¿ç¨‹å‘é€ä¸€ä¸ªä¿¡å·
     pthread_equal(): å¯¹ä¸¤ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ ‡è¯†å·è¿›è¡Œæ¯”è¾ƒ
     pthread_detach(): åˆ†ç¦»çº¿ç¨‹
     pthread_self(): æŸ¥è¯¢çº¿ç¨‹è‡ªèº«çº¿ç¨‹æ ‡è¯†å·
     //
     *åˆ›å»ºçº¿ç¨‹
     int pthread_create(pthread_t _Nullable * _Nonnull __restrict, //æŒ‡å‘æ–°å»ºçº¿ç¨‹æ ‡è¯†ç¬¦çš„æŒ‡é’ˆ
     const pthread_attr_t * _Nullable __restrict,  //è®¾ç½®çº¿ç¨‹å±æ€§. é»˜è®¤å€¼NULL. 
     void * _Nullable (* _Nonnull)(void * _Nullable),  //è¯¥çº¿ç¨‹è¿è¡Œå‡½æ•°çš„åœ°å€
     void * _Nullable __restrict);  //è¿è¡Œå‡½æ•°æ‰€éœ€çš„å‚æ•°
     *è¿”å›å€¼ï¼š
     *è‹¥çº¿ç¨‹åˆ›å»ºæˆåŠŸ, åˆ™è¿”å›0
     *è‹¥çº¿ç¨‹åˆ›å»ºå¤±è´¥, åˆ™è¿”å›å‡ºé”™ç¼–å·
     */
    
    //
    pthread_t thread = NULL;
    NSString *params = @"Hello World";
    int result = pthread_create(&thread, NULL, threadTask, (__bridge void *)(params));
    result == 0 ? NSLog(@"creat thread success") : NSLog(@"creat thread failure");
    //è®¾ç½®å­çº¿ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸ºdetached,åˆ™è¯¥çº¿ç¨‹è¿è¡Œç»“æŸåä¼šè‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æº
    pthread_detach(thread);
}

void *threadTask(void *params) {
    NSLog(@"%@ - %@", [NSThread currentThread], (__bridge NSString *)(params));
    return NULL;
}

```

çœ‹ä¸‹è¿™äº›APIè®¾è®¡å¯ä»¥è¯´æ˜¯ç›¸å½“ä¸å‹å¥½, å¹¶ä¸”éœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„å„ä¸ªçŠ¶æ€çš„è½¬æ¢å’Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†.

### NSThread

`NSThread`çš„APIè®¾è®¡å¤§è‡´å¦‚ä¸‹: 

```
@interface NSThread : NSObject
//å½“å‰çº¿ç¨‹
@property (class, readonly, strong) NSThread *currentThread;
//ä½¿ç”¨ç±»æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
+ (void)detachNewThreadWithBlock:(void (^)(void))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));
+ (void)detachNewThreadSelector:(SEL)selector toTarget:(id)target withObject:(nullable id)argument;
//åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºå¤šçº¿ç¨‹
+ (BOOL)isMultiThreaded;
//æŒ‡å®šçº¿ç¨‹çš„çº¿ç¨‹å‚æ•°, ä¾‹å¦‚è®¾ç½®å½“å‰çº¿ç¨‹çš„æ–­è¨€å¤„ç†å™¨. 
@property (readonly, retain) NSMutableDictionary *threadDictionary;
//å½“å‰çº¿ç¨‹æš‚åœåˆ°æŸä¸ªæ—¶é—´
+ (void)sleepUntilDate:(NSDate *)date;
//å½“å‰çº¿ç¨‹æš‚åœä¸€æ®µæ—¶é—´
+ (void)sleepForTimeInterval:(NSTimeInterval)ti;
//é€€å‡ºå½“å‰çº¿ç¨‹
+ (void)exit;
//å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§
+ (double)threadPriority;
//è®¾ç½®å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§
+ (BOOL)setThreadPriority:(double)p;
//æŒ‡å®šçº¿ç¨‹å¯¹è±¡ä¼˜å…ˆçº§ 0.0ï½1.0, é»˜è®¤å€¼ä¸º0.5
@property double threadPriority NS_AVAILABLE(10_6, 4_0);
//æœåŠ¡è´¨é‡
@property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);
//çº¿ç¨‹åç§°
@property (nullable, copy) NSString *name NS_AVAILABLE(10_5, 2_0);
//æ ˆåŒºå¤§å°
@property NSUInteger stackSize NS_AVAILABLE(10_5, 2_0);
//æ˜¯å¦ä¸ºä¸»çº¿ç¨‹
@property (class, readonly) BOOL isMainThread NS_AVAILABLE(10_5, 2_0);
//è·å–ä¸»çº¿ç¨‹
@property (class, readonly, strong) NSThread *mainThread NS_AVAILABLE(10_5, 2_0);
//åˆå§‹åŒ–
- (instancetype)init NS_AVAILABLE(10_5, 2_0) NS_DESIGNATED_INITIALIZER;
//å®ä¾‹æ–¹æ³•åˆå§‹åŒ–, éœ€è¦å†è°ƒç”¨startæ–¹æ³•
- (instancetype)initWithTarget:(id)target selector:(SEL)selector object:(nullable id)argument NS_AVAILABLE(10_5, 2_0);
- (instancetype)initWithBlock:(void (^)(void))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));
//çº¿ç¨‹çŠ¶æ€, æ­£åœ¨æ‰§è¡Œ
@property (readonly, getter=isExecuting) BOOL executing NS_AVAILABLE(10_5, 2_0);
//çº¿ç¨‹çŠ¶æ€, æ­£åœ¨å®Œæˆ
@property (readonly, getter=isFinished) BOOL finished NS_AVAILABLE(10_5, 2_0);
//çº¿ç¨‹çŠ¶æ€, å·²ç»å–æ¶ˆ
@property (readonly, getter=isCancelled) BOOL cancelled NS_AVAILABLE(10_5, 2_0);
//å–æ¶ˆ, ä»…ä»…æ”¹å˜çº¿ç¨‹çŠ¶æ€, å¹¶ä¸èƒ½åƒexistä¸€æ ·çœŸæ­£çš„ç»ˆæ­¢çº¿ç¨‹
- (void)cancel NS_AVAILABLE(10_5, 2_0);
//å¼€å§‹
- (void)start NS_AVAILABLE(10_5, 2_0);
//çº¿ç¨‹éœ€è¦æ‰§è¡Œçš„ä»£ç , ä¸€èˆ¬å†™å­ç±»çš„æ—¶å€™ä¼šç”¨åˆ°
- (void)main NS_AVAILABLE(10_5, 2_0);
@end

è¿˜æœ‰ä¸€ä¸ªNSObjectçš„åˆ†ç±»
@interface NSObject (NSThreadPerformAdditions)
//éšå¼çš„åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹, å¹¶åœ¨æŒ‡å®šçš„çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹æˆ–å­çº¿ç¨‹ï¼‰ä¸Šæ‰§è¡Œæ–¹æ³•. 
- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray<NSString *> *)array;
- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait;
- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray<NSString *> *)array NS_AVAILABLE(10_5, 2_0);
- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait NS_AVAILABLE(10_5, 2_0);
- (void)performSelectorInBackground:(SEL)aSelector withObject:(nullable id)arg NS_AVAILABLE(10_5, 2_0);
@end
```

å¸¸è§çš„ç”¨æ³•æœ‰ä»¥ä¸‹å‡ ç§: 

```
- (void) startThread {

    //åˆ›å»ºå¹¶ä¸”æ‰‹åŠ¨å¯åŠ¨
    NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(run) object:nil];
    [thread start];

    //ç±»æ–¹æ³•åˆ›å»ºå¹¶ä¸”è‡ªåŠ¨å¯åŠ¨
    [NSThread detachNewThreadSelector:@selector(run) toTarget:self withObject:nil];

    //é€šè¿‡NSObjectçš„æ–¹æ³•è‡ªåŠ¨å¯åŠ¨
    [self performSelectorInBackground:@selector(run) withObject:nil];
}    

- (void)run {
    NSLog(@"%@", [NSThread currentThread]);
}
```

### GCD

Grand Central Dispatch, å®ƒæ˜¯è‹¹æœä¸ºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—æå‡ºçš„è§£å†³æ–¹æ¡ˆ, ä¼šè‡ªåŠ¨åˆç†åœ°åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸(æ¯”å¦‚åŒæ ¸ã€å››æ ¸), æœ€é‡è¦çš„æ˜¯å®ƒä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ(åˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹), å®Œå…¨ä¸éœ€è¦æˆ‘ä»¬ç®¡ç†, æˆ‘ä»¬åªéœ€è¦å‘Šè¯‰å¹²ä»€ä¹ˆå°±è¡Œ. åŒæ—¶å®ƒä½¿ç”¨çš„ä¹Ÿæ˜¯Cè¯­è¨€, ä¸è¿‡ç”±äºä½¿ç”¨äº†Block(Swifté‡Œå«åšé—­åŒ…), ä½¿å¾—ä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿, è€Œä¸”çµæ´».

äº†è§£GCDæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸¤ä¸ªæ¦‚å¿µ, **`é˜Ÿåˆ—`**å’Œ**`ä»»åŠ¡`**.

1.  ä»»åŠ¡

     è¦æ‰§è¡Œçš„æ“ä½œæˆ–æ–¹æ³•å‡½æ•°. åœ¨GCDä¸­æŒ‡çš„å°±æ˜¯blockå—, åœ¨NSThreadä¸­æŒ‡çš„æ˜¯`performSelector:`ä¸­çš„æ–¹æ³•. åŠ å…¥ä»»åŠ¡æ—¶æœ‰ä¸¤ç§å½¢å¼: `åŒæ­¥ä»»åŠ¡(dispatch_sync)`å’Œ`å¼‚æ­¥ä»»åŠ¡(dispatch_async)`.

    1. åŒæ­¥ä»»åŠ¡: ä¸ä¼šå¼€å¯æ–°çš„çº¿ç¨‹, ä¼šé˜»å¡å½“å‰çº¿ç¨‹. å®Œæˆéœ€è¦åšçš„ä»»åŠ¡åæ‰ä¼šè¿”å›, è¿›è¡Œä¸‹ä¸€ä»»åŠ¡. åˆ›å»ºæ–¹å¼ä¸º:
        ```
         //æŠŠå³è¾¹çš„å‚æ•°(ä»»åŠ¡)æäº¤ç»™å·¦è¾¹çš„å‚æ•°(é˜Ÿåˆ—)è¿›è¡Œæ‰§è¡Œ
         dispatch_sync(dispatch_queue_t queue, dispatch_block_t block);
        ```
    2. å¼‚æ­¥ä»»åŠ¡: ä¸ä¼šç­‰å¾…ä»»åŠ¡å®Œæˆæ‰è¿”å›, ä¼šç«‹å³è¿”å›. å¼‚æ­¥æ˜¯å¤šçº¿ç¨‹çš„ä»£åè¯, å› ä¸ºå¿…å®šä¼šå¼€å¯æ–°çš„çº¿ç¨‹, çº¿ç¨‹çš„ç”³è¯·æ˜¯ç”±å¼‚æ­¥è´Ÿè´£, èµ·åˆ°å¼€åˆ†æ”¯çš„ä½œç”¨. åˆ›å»ºæ–¹å¼ä¸º:

        ```
         //æŠŠå³è¾¹çš„å‚æ•°(ä»»åŠ¡)æäº¤ç»™å·¦è¾¹çš„å‚æ•°(é˜Ÿåˆ—)è¿›è¡Œæ‰§è¡Œ
         dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
        ```
2.  é˜Ÿåˆ—

     å­˜æ”¾ä»»åŠ¡çš„é›†åˆ, æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ç„¶åæ‰§è¡Œ, GCDä¼šè‡ªåŠ¨å°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æŒ‰å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼å–å‡º. é˜Ÿåˆ—ä¸»è¦æœ‰çš„æœ‰`ä¸²è¡Œé˜Ÿåˆ—(Serial Dispatch Queue)`, `å¹¶è¡Œé˜Ÿåˆ—(Concurrent Dispatch Queue)`, `å…¨å±€é˜Ÿåˆ—(Global Queue)`å’Œ`ä¸»é˜Ÿåˆ—(Main Queue)`.

    1.   ä¸²è¡Œé˜Ÿåˆ—: ä»»åŠ¡ä¾æ¬¡æ‰§è¡Œ, åŒä¸€æ—¶é—´é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œ, æ¯ä¸ªä»»åŠ¡åªæœ‰åœ¨å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰èƒ½å¼€å§‹æ‰§è¡Œ. ä½ ä¸çŸ¥é“åœ¨ä¸€ä¸ªBlock(ä»»åŠ¡)æ‰§è¡Œç»“æŸåˆ°ä¸‹ä¸€ä¸ªBlock(ä»»åŠ¡)å¼€å§‹æ‰§è¡Œä¹‹é—´çš„è¿™æ®µæ—¶é—´æ—¶é—´æ˜¯å¤šé•¿, è¿™éƒ¨åˆ†æ˜¯ç”±GCDæ§åˆ¶. åˆ›å»ºæ–¹å¼ä¸º:

          ```
           //åˆ›å»ºä¸€ä¸ªåä¸ºqueueçš„ä¸²è¡Œé˜Ÿåˆ—
           //ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé˜Ÿåˆ—åç§°
           //ç¬¬äºŒä¸ªå‚æ•°ä¸ºé˜Ÿåˆ—ç±»å‹, DISPATCH_QUEUE_SERIALå’ŒNULLè¡¨ç¤ºä¸²è¡Œé˜Ÿåˆ—
           dispatch_queue_t queue = dispatch_queue_create("com.private.SerialQueue", DISPATCH_QUEUE_SERIAL);
          ```

    2.   å¹¶è¡Œé˜Ÿåˆ—: ä»»åŠ¡å¹¶å‘æ‰§è¡Œ, å”¯ä¸€èƒ½ä¿è¯çš„æ˜¯, è¿™äº›ä»»åŠ¡ä¼šæŒ‰ç…§è¢«æ·»åŠ çš„é¡ºåºå¼€å§‹æ‰§è¡Œ. ä½†æ˜¯ä»»åŠ¡å¯ä»¥ä»¥ä»»ä½•é¡ºåºå®Œæˆ, ä½ ä¸çŸ¥é“åœ¨æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡æ˜¯ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹, æˆ–è€…è¯´ä»»æ„æ—¶åˆ»æœ‰å¤šä¸ªBlock(ä»»åŠ¡)è¿è¡Œ, è¿™ä¸ªå®Œå…¨æ˜¯å–å†³äºGCD. GCDé»˜è®¤å·²ç»æä¾›äº†å…¨å±€çš„å¹¶å‘é˜Ÿåˆ—, ä¾›æ•´ä¸ªåº”ç”¨ä½¿ç”¨, ä¸€èˆ¬ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºåˆ›å»ºæ–¹å¼ä¸º:

          ```
           //åˆ›å»ºä¸€ä¸ªåä¸ºqueueçš„å¹¶è¡Œé˜Ÿåˆ—
           //ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé˜Ÿåˆ—åç§°
           //ç¬¬äºŒä¸ªå‚æ•°ä¸ºé˜Ÿåˆ—ç±»å‹, DISPATCH_QUEUE_CONCURRENTè¡¨ç¤ºå¹¶è¡Œé˜Ÿåˆ—
           dispatch_queue_t queue = dispatch_queue_create("com.private.ConcurrentQueue",DISPATCH_QUEUE_CONCURRENT);
          ```

    3.   å…¨å±€é˜Ÿåˆ—: **éš¶å±äºå¹¶è¡Œé˜Ÿåˆ—**, ä¸è¦ä¸ barrier æ …æ æ–¹æ³•æ­é…ä½¿ç”¨, barrier åªæœ‰ä¸è‡ªå®šä¹‰çš„å¹¶è¡Œé˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨, æ‰èƒ½è®© barrier è¾¾åˆ°æˆ‘ä»¬æ‰€æœŸæœ›çš„æ …æ åŠŸèƒ½. ä¸ä¸²è¡Œé˜Ÿåˆ—æˆ–è€…globalé˜Ÿåˆ— ä¸€èµ·ä½¿ç”¨, barrierçš„è¡¨ç°ä¼šå’Œdispatch_syncæ–¹æ³•ä¸€æ ·. åˆ›å»ºæ–¹å¼ä¸º:

          ```
           //è·å–ç³»ç»Ÿå…¨å±€é˜Ÿåˆ—, å¹¶èµ‹å€¼ç»™é˜Ÿåˆ—queue
           //ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¼˜å…ˆçº§, è¿™é‡Œæ˜¯æ–°è€ä¼˜å…ˆçº§çš„å¯¹ç…§Map
         *  - DISPATCH_QUEUE_PRIORITY_HIGH:         QOS_CLASS_USER_INITIATED//é«˜
         *  - DISPATCH_QUEUE_PRIORITY_DEFAULT:      QOS_CLASS_DEFAULT//é»˜è®¤
         *  - DISPATCH_QUEUE_PRIORITY_LOW:          QOS_CLASS_UTILITY//ä½
         *  - DISPATCH_QUEUE_PRIORITY_BACKGROUND:   QOS_CLASS_BACKGROUND//åå°

         //ç¬¬äºŒä¸ªå‚æ•°æ˜¯é¢„ç•™å‚æ•°, ä¼ 0å°±å¥½
         dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
          ```

    4.   ä¸»é˜Ÿåˆ—: **éš¶å±äºä¸²è¡Œé˜Ÿåˆ—**, ä¸èƒ½ä¸syncåŒæ­¥æ–¹æ³•æ­é…ä½¿ç”¨, ä¼šé€ æˆæ­»å¾ªç¯. ä¸»é˜Ÿåˆ—æ˜¯GCDè‡ªå¸¦çš„ä¸€ç§ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—, æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡, éƒ½ä¼šæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ. åˆ›å»ºæ–¹å¼ä¸º:

          ```
           //è·å–ç³»ç»Ÿä¸»é˜Ÿåˆ—, å¹¶èµ‹å€¼ç»™é˜Ÿåˆ—queue
           dispatch_queue_t queue = dispatch_get_main_queue();
          ```

ä¸ç®¡æ˜¯ä¸²è¡Œé˜Ÿåˆ—(SerialQueue)è¿˜æ˜¯å¹¶è¡Œé˜Ÿåˆ—(ConcurrencyQueue), éƒ½æ˜¯FIFOé˜Ÿåˆ—. ä¹Ÿå°±æ„å‘³ç€, ä»»åŠ¡ä¸€å®šæ˜¯ä¸€ä¸ªä¸€ä¸ªåœ°, æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ¥æ‰§è¡Œ.

### NSOperation & NSOperationQueue

`NSOperation` æ˜¯è‹¹æœå…¬å¸å¯¹`GCD`çš„å°è£…, å®Œå…¨é¢å‘å¯¹è±¡, æ‰€ä»¥ä½¿ç”¨èµ·æ¥æ›´å¥½ç†è§£. å¤§å®¶å¯ä»¥çœ‹åˆ° `NSOperation`å’Œ`NSOperationQueue`åˆ†åˆ«å¯¹åº”`GCD`çš„**ä»»åŠ¡**å’Œ**é˜Ÿåˆ—**. æ‰€ä»¥ä»–çš„æ“ä½œæ­¥éª¤å’Œ`GCD`ç±»ä¼¼: é¦–å…ˆå°†è¦æ‰§è¡Œçš„ä»»åŠ¡å°è£…åˆ°ä¸€ä¸ª`NSOperation`å¯¹è±¡ä¸­. ç„¶åå°†æ­¤ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ª`NSOperationQueue`å¯¹è±¡ä¸­, ç„¶åç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åœ¨æ‰§è¡Œä»»åŠ¡.

1. `NSOperation`ä¸»è¦æœ‰ä¸€ä¸‹è¿™äº›å±æ€§å’Œæ–¹æ³•. 

         â€‹```
        @interface NSOperation : NSObject {
        @private
            id _private;
            int32_t _private1;
        #if __LP64__
            int32_t _private1b;
        #endif
        }
        
        - (void)start;//å¯åŠ¨ä»»åŠ¡ é»˜è®¤åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ
        - (void)main;//è‡ªå®šä¹‰NSOperationï¼Œå†™ä¸€ä¸ªå­ç±»ï¼Œé‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æ·»åŠ éœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚
        
        @property (readonly, getter=isCancelled) BOOL cancelled;//æ˜¯å¦å·²ç»å–æ¶ˆï¼Œåªè¯»
        - (void)cancel;//å–æ¶ˆä»»åŠ¡
        
        @property (readonly, getter=isExecuting) BOOL executing;//æ­£åœ¨æ‰§è¡Œï¼Œåªè¯»
        @property (readonly, getter=isFinished) BOOL finished;//æ‰§è¡Œç»“æŸï¼Œåªè¯»
        @property (readonly, getter=isConcurrent) BOOL concurrent; // To be deprecated; use and override 'asynchronous' below
        @property (readonly, getter=isAsynchronous) BOOL asynchronous NS_AVAILABLE(10_8, 7_0);//æ˜¯å¦å¹¶å‘ï¼Œåªè¯»
        @property (readonly, getter=isReady) BOOL ready;//å‡†å¤‡æ‰§è¡Œ
        
        - (void)addDependency:(NSOperation *)op;//æ·»åŠ ä¾èµ–
        - (void)removeDependency:(NSOperation *)op;//ç§»é™¤ä¾èµ–
        
        @property (readonly, copy) NSArray<NSOperation *> *dependencies;//æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œåªè¯»
        
        typedef NS_ENUM(NSInteger, NSOperationQueuePriority) {
            NSOperationQueuePriorityVeryLow = -8L,
            NSOperationQueuePriorityLow = -4L,
            NSOperationQueuePriorityNormal = 0,
            NSOperationQueuePriorityHigh = 4,
            NSOperationQueuePriorityVeryHigh = 8
        };//ç³»ç»Ÿæä¾›çš„ä¼˜å…ˆçº§å…³ç³»æšä¸¾
        
        @property NSOperationQueuePriority queuePriority;//æ‰§è¡Œä¼˜å…ˆçº§
        
        @property (nullable, copy) void (^completionBlock)(void) NS_AVAILABLE(10_6, 4_0);//ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åçš„å›è°ƒ
        
        - (void)waitUntilFinished NS_AVAILABLE(10_6, 4_0);//é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰åˆ°æŸä¸ªoperationæ‰§è¡Œå®Œæ¯•ã€‚
        
        @property double threadPriority NS_DEPRECATED(10_6, 10_10, 4_0, 8_0);//å·²åºŸå¼ƒï¼Œç”¨qualityOfServiceæ›¿ä»£ã€‚
        
        @property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);//æœåŠ¡è´¨é‡ï¼Œä¸€ä¸ªé«˜è´¨é‡çš„æœåŠ¡å°±æ„å‘³ç€æ›´å¤šçš„èµ„æºå¾—ä»¥æä¾›æ¥æ›´å¿«çš„å®Œæˆæ“ä½œã€‚
        
        @property (nullable, copy) NSString *name NS_AVAILABLE(10_10, 8_0);//ä»»åŠ¡åç§°
        
        @end
        â€‹```

    ç”±äº`NSOperation`æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±», ä¸èƒ½ç›´æ¥ä½¿ç”¨, åœ¨è¿™é‡Œæˆ‘ä¹ˆä½ ä¸€èˆ¬ä½¿ç”¨`NSOperation`çš„ä¸¤ä¸ªå­ç±»`NSInvocationOperation`å’Œ`NSBlockOperation`, æˆ–è€…`NSOperationçš„è‡ªå®šä¹‰å­ç±»`:

        1. `NSInvocationOperation`åŸºäºåº”ç”¨çš„ä¸€ä¸ªtargetå¯¹è±¡å’Œselectoræ¥åˆ›å»ºoperation object. å¦‚æœä½ å·²ç»æœ‰ç°æœ‰çš„æ–¹æ³•æ¥æ‰§è¡Œéœ€è¦çš„ä»»åŠ¡, å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±». ä½¿ç”¨æ–¹å¼å¤§è‡´å¦‚ä¸‹: 

        ```
        - (void)NSInvocationOperationRun {
            NSInvocationOperation *invocationOper = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(invocationOperSel) object:nil];
            [invocationOper start];
        }
        - (void)invocationOperSel {
            NSLog(@"NSInvocationOperationRun_%@", [NSThread currentThread]);
        }
        ```
    ä»æ‰“å°ç»“æœå¯ä»¥çœ‹å‡º, è¯¥å®ç°æ–¹å¼æ˜¯åŒæ­¥é¡ºåºæ‰§è¡Œ.

        2.  `NSBlockOperation`ç”¨æ¥å¹¶å‘åœ°æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªblockå¯¹è±¡. operation objectä½¿ç”¨**ç»„**çš„è¯­ä¹‰æ¥æ‰§è¡Œå¤šä¸ªblockå¯¹è±¡ï¼Œæ‰€æœ‰ç›¸å…³çš„ block éƒ½æ‰§è¡Œå®Œæˆä¹‹å, operation objectæ‰ç®—å®Œæˆ. ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹
    
             ```
             //ç³»ç»Ÿæä¾›çš„API
             @interface NSBlockOperation : NSOperation {
             @private
                 id _private2;
                 void *_reserved2;
             }
             
            + (instancetype)blockOperationWithBlock:(void (^)(void))block;//åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ
        
            - (void)addExecutionBlock:(void (^)(void))block;//æ–°å¼€çº¿ç¨‹æ‰§è¡Œ
            @property (readonly, copy) NSArray<void (^)(void)> *executionBlocks;
        
            @end
             ```

        ä½¿ç”¨`NSBlockOperation`ç±»æ–¹æ³•åˆ›å»ºä»»åŠ¡, ä»æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºæ¥è¯¥ä»»åŠ¡æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„

            ```
            - (void)NSBlockOperationRun {
                NSBlockOperation *blockOper = [NSBlockOperation blockOperationWithBlock:^{
                    NSLog(@"NSBlockOperationRun_%@_%@", [NSOperationQueue currentQueue], [NSThread currentThread]);
                }];
                [blockOper start];
            }
            ```

        ä½¿ç”¨`NBlockOperation`çš„å®ä¾‹æ–¹æ³•åˆ›å»ºä»»åŠ¡, ä»æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºæ¥, ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ, å…¶ä»–ä»»åŠ¡å‡æ˜¯æ–°å¼€çš„çº¿ç¨‹, æ‰€æœ‰çš„ä»»åŠ¡æ˜¯ä»¥å¼‚æ­¥å¹¶å‘çš„å½¢å¼æ‰§è¡Œ. 

            ```
            - (void)NSBlockOperationRun {
                NSBlockOperation *blockOper = [NSBlockOperation blockOperationWithBlock:^{
                    NSLog(@"NSBlockOperationRun_1_%@", [NSThread currentThread]);
                }];
                [blockOper addExecutionBlock:^{
                    NSLog(@"NSBlockOperationRun_2_%@", [NSThread currentThread]);
                }];
                [blockOper addExecutionBlock:^{
                    NSLog(@"NSBlockOperationRun_3_%@", [NSThread currentThread]);
                }];
                [blockOper addExecutionBlock:^{
                    NSLog(@"NSBlockOperationRun_4_%@", [NSThread currentThread]);
                }];
                [blockOper start];
            }
            ```
            
        3. `NSOperationçš„è‡ªå®šä¹‰å­ç±»`. 
        
            ```        
            åœ¨å­ç±»ä¸­é‡å†™çˆ¶ç±»çš„`-(void)main`å‡½æ•°, åœ¨é‡Œé¢å®ç°ä¸»è¦é€»è¾‘
            ```

     `NSBlockOperation`, `NSBlockOperationRun`æˆ–è€…`NSOperationçš„è‡ªå®šä¹‰å­ç±»`åˆ›å»ºçš„operation objectéƒ½å¯ä»¥ä½¿ç”¨`NSOperation`çš„æ‰€æœ‰å±æ€§, æ„å‘³ç€ä»–ä»¬å…·æœ‰ä»¥ä¸‹ä¸»è¦ç‰¹æ€§: 

    1. å¤šä¸ªä»»åŠ¡ä¹‹é—´å¯ä»¥ä½¿ç”¨æœ‰ä¾èµ–å…³ç³»
    2. å¯ä»¥è·å¾—Operation objectä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åçš„å›è°ƒ
    3. æ”¯æŒåº”ç”¨ä½¿ç”¨ KVO é€šçŸ¥æ¥ç›‘æ§ operation çš„æ‰§è¡ŒçŠ¶æ€
    4. å¯ä»¥é€šè¿‡operationä¼˜å…ˆçº§, ä»è€Œå½±å“ç›¸å¯¹çš„æ‰§è¡Œé¡ºåº
    5. å¯ä»¥ç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡

2. `NSOperationQueue`

    ç±»ä¼¼äºGCDä¸­çš„é˜Ÿåˆ—, åªéœ€è¦å§ä»»åŠ¡åŠ å…¥åˆ°`NSOperationQueue`ä¸­, å°±ä¼šè‡ªåŠ¨è¿è¡Œ, ç”±ç³»ç»Ÿé€šè¿‡æœ€å¤§å¹¶å‘æ•°æ¥æ§åˆ¶æ˜¯å¹¶è¡Œè¿˜æ˜¯ä¸²è¡Œ, å®˜æ–¹æä¾›çš„APIå¦‚ä¸‹:
    
    ```
    static const NSInteger NSOperationQueueDefaultMaxConcurrentOperationCount = -1;
    
    NS_CLASS_AVAILABLE(10_5, 2_0)
    @interface NSOperationQueue : NSObject {
    @private
        id _private;
        void *_reserved;
    }
    
    - (void)addOperation:(NSOperation *)op;//å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡
    - (void)addOperations:(NSArray<NSOperation *> *)ops waitUntilFinished:(BOOL)wait API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//æ·»åŠ ä¸€ç»„ä»»åŠ¡
    
    - (void)addOperationWithBlock:(void (^)(void))block API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//æ·»åŠ ä¸€ä¸ªblockå½¢å¼çš„ä»»åŠ¡
    
    @property (readonly, copy) NSArray<__kindof NSOperation *> *operations;//é˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡çš„æ•°ç»„
    @property (readonly) NSUInteger operationCount API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//é˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡æ•°
    
    @property NSInteger maxConcurrentOperationCount;//æœ€å¤§å¹¶å‘æ•°
    
    @property (getter=isSuspended) BOOL suspended;//æš‚åœ
    
    @property (nullable, copy) NSString *name API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//åç§°
    
    @property NSQualityOfService qualityOfService API_AVAILABLE(macos(10.10), ios(8.0), watchos(2.0), tvos(9.0));//æœåŠ¡è´¨é‡, ç³»ç»Ÿä¼šä¸ºæƒé‡é«˜çš„æœåŠ¡åˆ†é…æ›´å¤šçš„èµ„æº
    
    @property (nullable, assign /* actually retain */) dispatch_queue_t underlyingQueue API_AVAILABLE(macos(10.10), ios(8.0), watchos(2.0), tvos(9.0));
    
    - (void)cancelAllOperations;//å–æ¶ˆé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ä»»åŠ¡
    
    - (void)waitUntilAllOperationsAreFinished;//é˜»å¡å½“å‰çº¿ç¨‹, ç­‰åˆ°é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•
    
    @property (class, readonly, strong, nullable) NSOperationQueue *currentQueue API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//è·å–å½“å‰é˜Ÿåˆ—
    @property (class, readonly, strong) NSOperationQueue *mainQueue API_AVAILABLE(macos(10.6), ios(4.0), watchos(2.0), tvos(9.0));//è·å–ä¸»é˜Ÿåˆ—
    
    @end

    ```
    
    ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:
    
    ```
    //ä»¥ä¸‰ç§æ–¹å¼ä¸ºé˜Ÿåˆ—æ·»åŠ äº†ä¸‰ä¸ªä»»åŠ¡, 
    - (void)NSOperationQueueRun {
        NSOperationQueue *queue = [[NSOperationQueue alloc] init];
        NSInvocationOperation *invocationOper = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(invocationOperSel) object:nil];
        [queue addOperation:invocationOper];
        NSBlockOperation *blockOper = [NSBlockOperation blockOperationWithBlock:^{
            NSLog(@"NSBlockOperationRun_%@", [NSThread currentThread]);
        }];
        [queue addOperation:blockOper];
        [queue addOperationWithBlock:^{
            NSLog(@"QUEUEBlockOperationRun_%@", [NSThread currentThread]);
        }];
    }
    
    - (void)invocationOperSel {
        NSLog(@"NSInvocationOperationRun_%@", [NSThread currentThread]);
    }
    ```
    ä¸€èˆ¬æƒ…å†µä¸‹, `NSOperationQueue`ä¼šæŒ‰ç…§ä»»åŠ¡æ·»åŠ çš„é¡ºåºæ¥æ‰§è¡Œä»»åŠ¡, ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»æ¥æ”¹å˜æ‰§è¡Œé¡ºåº. å¹¶å‘æ•°å¤§äºä»»åŠ¡æ•°, æ²¡æœ‰è®¾ç½®ä¾èµ–å…³ç³», å¹¶ä¸”åœ¨åŒä¸€é˜Ÿåˆ—.
    
## å¸¸è§çš„ä½¿ç”¨æ–¹å¼

### GCDå‘å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡

è¯¥è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸¤æ­¥, ç¬¬ä¸€æ­¥è·å–ç³»ç»Ÿæä¾›çš„å…¨å±€å¹¶è¡Œé˜Ÿåˆ—, ç¬¬äºŒæ­¥å‘å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡. ä»»åŠ¡ä¼šéµå®ˆFIFOåŸåˆ™æ¥æ‰§è¡Œ, ä½†æ˜¯æ¯ä¸ªä»»åŠ¡ä½•æ—¶æ‰§è¡Œå®Œæˆ‘ä»¬å´å¹¶ä¸çŸ¥é“. ä½†æ˜¯ç³»ç»Ÿä¼šæ–°å¼€çº¿ç¨‹æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡, ä¸‰ä¸ªå¼‚æ­¥ä»»åŠ¡ä¼šåˆ†åˆ«åœ¨ä¸‰ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ, å„ä¸ªä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ— æ³•ç¡®å®š.

```
- (void)test1 {
    //è·å–ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡1----%@", [NSThread currentThread]);
        sleep(5);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡2----%@", [NSThread currentThread]);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡3----%@", [NSThread currentThread]);
    });
}
```

### GCDå‘ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡

è¯¥è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸¤æ­¥, ç¬¬ä¸€æ­¥åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—, ç¬¬äºŒæ­¥å‘å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡. ä»»åŠ¡ä¼šéµå®ˆFIFOåŸåˆ™æ¥æ‰§è¡Œ, æ¯ä¸ªä»»åŠ¡ä½•æ—¶æ‰§è¡Œå®Œæˆ‘ä»¬å´å¹¶ä¸çŸ¥é“. ä½†æ˜¯ç”±äºæˆ‘ä»¬æ˜¯åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ çš„ä»»åŠ¡, ä¸ä¼šæ–°å¼€çº¿ç¨‹, æ‰€æœ‰çš„å¼‚æ­¥ä»»åŠ¡ä¼šæŒ‰ç…§é¡ºåºå‰ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œåä¸€ä¸ª.

 ```
 - (void)test2 {
    //åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„åç§°, ç¬¬äºŒä¸ªå‚æ•°ä¸ºé˜Ÿåˆ—çš„å±æ€§, NULLæˆ–è€…DISPATCH_QUEUE_SERIALè¡¨ç¤ºæ˜¯ä¸²è¡Œé˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_queue_create("test2", NULL);
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡1----%@", [NSThread currentThread]);
        sleep(5);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡2----%@", [NSThread currentThread]);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡3----%@", [NSThread currentThread]);
    });
}
 ```

### GCDå‘å¹¶è¡Œé˜Ÿåˆ—æ·»åŠ åŒæ­¥ä»»åŠ¡

è¯¥è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸¤æ­¥, ç¬¬ä¸€æ­¥è·å–ç³»ç»Ÿæä¾›çš„å…¨å±€å¹¶è¡Œé˜Ÿåˆ—, ç¬¬äºŒæ­¥å‘å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ åŒæ­¥ä»»åŠ¡. ä»»åŠ¡ä¼šéµå®ˆFIFOåŸåˆ™æ¥æ‰§è¡Œ, æ¯ä¸ªä»»åŠ¡ä½•æ—¶æ‰§è¡Œå®Œæˆ‘ä»¬å´å¹¶ä¸çŸ¥é“. è™½ç„¶æ˜¯å¹¶è¡Œé˜Ÿåˆ—, å•ç”±äºæ·»åŠ çš„æ˜¯åŒæ­¥ä»»åŠ¡, ä¸ä¼šæ–°å¼€çº¿ç¨‹, å…¨éƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ, æ‰€ä»¥ä¸‰ä¸ªä»»åŠ¡ä¼šé¡ºåºæ‰§è¡Œ, å¹¶è¡Œé˜Ÿåˆ—å¤±å»äº†å¹¶è¡Œçš„èƒ½åŠ›. 

```
//å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ åŒæ­¥ä»»åŠ¡
- (void)test3 {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_sync(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡1----%@", [NSThread currentThread]);
        sleep(5);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_sync(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡2----%@", [NSThread currentThread]);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_sync(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡3----%@", [NSThread currentThread]);
    });
}
```

### GCD å‘ä¸²è¡Œé˜Ÿåˆ—æ·»åŠ å¼‚æ­¥ä»»åŠ¡

è¯¥è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸¤æ­¥, ç¬¬ä¸€æ­¥åˆ›å»ºè‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—, ç¬¬äºŒæ­¥å‘å¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡. è™½ç„¶å¼‚æ­¥ä»»åŠ¡ä¼šæ–°å¼€çº¿ç¨‹, ä½†æ˜¯ç”±äºæ˜¯åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­æ‰§è¡Œ, æ‰€ä»¥ä¸æ–°å¼€çº¿ç¨‹, æ‰€æœ‰ä»»åŠ¡å‰ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œä¸‹ä¸€ä¸ª.

```
- (void)test4 {
    dispatch_queue_t queue = dispatch_queue_create("test4", NULL);
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡1----%@", [NSThread currentThread]);
        sleep(5);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡2----%@", [NSThread currentThread]);
    });
    
    //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å¼‚æ­¥ä»»åŠ¡
    dispatch_async(queue, ^{
        NSLog(@"ä¸‹è½½å›¾ç‰‡3----%@", [NSThread currentThread]);
    });
}
``` 

### GCDç›‘å¬å¹¶è¡Œé˜Ÿåˆ—ä¸­å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆ(Dispatch Group)

åˆ†ç»„æ¨¡å¼ `dispatch_group_notify`. å¯ä»¥å¼‚æ­¥æ‰§è¡Œå¤šä¸ªè€—æ—¶æ“ä½œ. ç­‰è€—æ—¶æ“ä½œéƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šå›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œæ“ä½œ, ä¸»è¦ç”¨äºç›‘å¬ä»»åŠ¡æ˜¯å¦å®Œæˆ. ä¸»è¦æœ‰ä¸¤ç§ç”¨æ³•: 

ç¬¬ä¸€ç§ç”¨æ³•æ˜¯é€šè¿‡`dispatch_group_async`, é¦–å…ˆåˆ›å»ºä¸€ä¸ªå…¨å±€å¹¶è¡Œé˜Ÿåˆ—å’Œä¸€ä¸ªgroupé˜Ÿåˆ—ç»„, å†æ¬¡åˆ›å»ºå¼‚æ­¥groupä»»åŠ¡åŠ å…¥åˆ°å‰é¢åˆ›å»ºçš„groupé˜Ÿåˆ—ä¸­å». å½“æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å®Œæˆå, ä¼šé€šè¿‡`dispatch_group_notify`å›åˆ°ä¸»çº¿ç¨‹.

```
- (void)groupTest1 {
    //è·å–å…¨å±€é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    //åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ç»„
    dispatch_group_t group = dispatch_group_create();
    
    dispatch_group_async(group, queue, ^{
        NSLog(@"--- 1 å¼€å§‹--- %@", [NSThread currentThread]);
        //å»¶æ—¶5ç§’ æ¨¡ä»¿å µå¡å­çº¿ç¨‹
        [NSThread sleepForTimeInterval:5];
        NSLog(@"--- 1 --- å®Œæˆ %@", [NSThread currentThread]);
    });
    
    dispatch_group_async(group, queue, ^{
        NSLog(@"--- 2 å¼€å§‹--- %@", [NSThread currentThread]);
        //å»¶æ—¶5ç§’ æ¨¡ä»¿å µå¡å­çº¿ç¨‹
        [NSThread sleepForTimeInterval:5];
        NSLog(@"--- 2 --- å®Œæˆ %@", [NSThread currentThread]);
    });
    
    //åœ¨è¿™ä¸ªé˜Ÿåˆ—ç»„é‡Œé¢ï¼Œä¼šç­‰groupä¸­çš„å…¨éƒ¨ä»£ç æ‰§è¡Œå®Œæ¯•å†å»æ‰§è¡Œå…¶å®ƒçš„æ“ä½œ
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        // ç­‰å‰é¢çš„å¼‚æ­¥æ“ä½œéƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå›åˆ°ä¸»çº¿ç¨‹...
        NSLog(@"å…¨éƒ¨å®Œæˆ");
    });
}
```

ç¬¬äºŒç§ç”¨æ³•æ˜¯é€šè¿‡ä¿¡å·é‡`dispatch_group_enter` å’Œ `dispatch_group_leave`. åˆ›å»ºä¸€ä¸ªå¹¶è¡Œçº¿ç¨‹å’Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡, å°†å¼‚æ­¥ä»»åŠ¡æ·»åŠ åˆ°å¹¶è¡Œçº¿ç¨‹ä¸­åŒº. é€šè¿‡`dispatch_group_enter`æ¥å‘ŠçŸ¥`group`ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å¼€å§‹,  æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°åŠ 1. åœ¨å¼‚æ­¥çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ—¶, é€šè¿‡`dispatch_group_leave`å‘ŠçŸ¥group, ä¸€ä¸ªä»»åŠ¡ç»“æŸ, æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°å‡1. å½“æœªæ‰§è¡Œå®Œæ¯•ä»»åŠ¡æ•°ä¸º0çš„æ—¶å€™, è¿™æ—¶groupæ‰è®¤ä¸ºç»„å†…ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•äº†(è¿™ä¸ªå’ŒGCDçš„ä¿¡å·é‡çš„æœºåˆ¶æœ‰äº›ç›¸ä¼¼), è¿™æ—¶å€™æ‰ä¼šå›è°ƒ`dispatch_group_notify`ä¸­çš„block. æ­¤å¤„éœ€è¦æ³¨æ„, `dispatch_group_enter`å’Œ`dispatch_group_leave`çš„æ•°é‡ä¸€å®šè¦ä¸€è‡´. 

```
- (void)groupTest2 {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_group_t group = dispatch_group_create();
    
    dispatch_group_enter(group);
    dispatch_async(queue, ^{
        sleep(2); //è¿™é‡Œçº¿ç¨‹ç¡çœ 1ç§’é’Ÿï¼Œæ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚
        NSLog(@"%@ one finish", [NSThread currentThread]);
        dispatch_group_leave(group);
    });
    
    dispatch_group_enter(group);
    dispatch_async(queue, ^{
        sleep(2); //è¿™é‡Œçº¿ç¨‹ç¡çœ 1ç§’é’Ÿï¼Œæ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚
        NSLog(@"%@ two finish", [NSThread currentThread]);
        dispatch_group_leave(group);
    });
    
    dispatch_group_notify(group, queue, ^{
        NSLog(@"group finished");
    });
}
```

### GCDå»¶æ—¶æ“ä½œ(dispatch_after)

ä½¿ç”¨å¾ˆç®€å•, ä¸¤ä¸ªæ ¸å¿ƒçš„å¯¹è±¡`dispatch_time_t`å’Œ`dispatch_after`. å¤§å®¶éƒ½ç»å¸¸ä½¿ç”¨, ä¸ç”¨å¤šè¯´. ä¸‹é¢çš„ä»£ç å’Œåœ¨3å¦™æ‰‹ç”¨`dispatch_async`å‡½æ•°è¿½åŠ blockåˆ°ä¸»çº¿ç¨‹çš„æ“ä½œæ˜¯ç›¸åŒçš„

```
- (void)afterTest {
    double delayInSeconds = 2.0;
    dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t) (delayInSeconds * NSEC_PER_SEC));
    //ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨æ—¶é—´, ç¬¬äºŒå„å‚æ•°ä»£è¡¨è¦åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œæ¥ä¸‹æ¥çš„ä»»åŠ¡, ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ä»»åŠ¡block
    dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
        NSLog(@"%@", [NSThread currentThread]);
    });
}
```

### GCDå•ä¾‹(dispatch_once)

è¿™ä¸ªæ›´æ˜¯ä¸ç”¨å¤šè¯´, ç›´æ¥è´´ä¸Šä»£ç .

```
@interface Tool : NSObject
+ (instancetype)sharedTool;
@end

@implementation Tool
static id _instance;
+ (instancetype)sharedTool {
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        _instance = [[Tool alloc] init];
    });
    return _instance;
}
@end
```

### GCD çº¿ç¨‹é—´çš„é€šè®¯

å¸¸ç”¨çš„æ–¹å¼å°±æ˜¯åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œé•¿æ—¶é—´ä»»åŠ¡, å¤„ç†ç»“æŸæ—¶, ä¸»çº¿ç¨‹ä½¿ç”¨è¯¥å¤„ç†ç»“æœ. ä»£ç å¦‚ä¸‹: 

```
- (void)threadTest {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_async(queue, ^{
        //åœ¨è¿™é‡Œæ‰§è¡Œè€—æ—¶çš„æ“ä½œ
        dispatch_async(dispatch_get_main_queue(), ^{
            //åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨ä¸Šé¢æ“ä½œçš„ç»“æœ
        });
    });
}
```

### GCDé‡å¤æ‰§è¡ŒåŒä¸€ä¸ªä»»åŠ¡(dispatch_apply)

`disaptch_apply`å‡½æ•°æ˜¯`dispatch_sync`å‡½æ•°å’Œ`Dispatch Group`çš„å…³è”API, è¯¥å‡½æ•°æŒ‰ç…§æŒ‡å®šçš„æ¬¡æ•°å°†æŒ‡å®šçš„Blockè¿½åŠ åˆ°æŒ‡å®šçš„Dispatch Queueä¸­, å¹¶ç­‰å¾…å¤„ç†æ‰§è¡Œç»“æŸ. 

```
- (void)applyTest {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_apply(10, queue, ^(size_t index) {
        //å¹¶è¡Œå¤„ç†10æ¬¡ä»»åŠ¡
        NSLog(@"%zu", index);
    });
}
```

ä½†æ˜¯ç”±äº`dispatch_apply`å‡½æ•°ä¸`dispatch_sync`å‡½æ•°ç›¸åŒ, ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸ, æ‰€ä»¥æˆ‘ä»¬å¼ºçƒˆæ¨èåœ¨`dispatch_async`å‡½æ•°ä¸­å¼‚æ­¥æ‰§è¡Œ. 

```
- (void)applyTest {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    //åœ¨å…¨å±€å¹¶è¡Œé˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œ
    dispatch_async(queue, ^{
        //ç­‰å¾…å‡½æ•°ä¸­æ“ä½œå…¨éƒ¨æ‰§è¡Œå®Œæ¯•
        dispatch_apply(10, queue, ^(size_t index) {
            //å¹¶è¡Œå¤„ç†10æ¬¡ä»»åŠ¡
            sleep(2);
            NSLog(@"%zu", index);
        });
        
        //dispatch_applyä¸­çš„å¤„ç†å…¨éƒ¨ç»“æŸ, åœ¨ä¸»çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ
        dispatch_async(dispatch_get_main_queue(), ^{
            NSLog(@"Done");
        });
    });
}
```

### GCDè®¾ç½®ä¼˜å…ˆçº§(dispatch_set_target_queue)

å°†queueçš„ä¼˜å…ˆçº§é€šè¿‡`dispatch_set_target_queue`å˜æ›´çš„å’Œqueue1çš„ä¼˜å…ˆçº§ä¸€è‡´, ä»£ç å¦‚ä¸‹. 

```
- (void)targetQueeuTest {
    dispatch_queue_t queue = dispatch_queue_create("test", NULL);
    dispatch_queue_t queue1 = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    //æŠŠç¬¬ä¸€ä¸ªå‚æ•°çš„æ‰§è¡Œä¼˜å…ˆçº§è®¾ç½®çš„å’Œç¬¬äºŒä¸ªå‚æ•°çš„ä¼˜å…ˆçº§ä¸€è‡´.
    dispatch_set_target_queue(queue, queue1);
}
```

### GCDæ …æ (dispatch_barrier_async)

ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹, å‡è®¾ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ äº†äº”ä¸ªå¼‚æ­¥ä»»åŠ¡, è™½ç„¶éµå¾ªFIFOçš„åŸåˆ™, è¿™äº”ä¸ªä»»åŠ¡çš„æ‰§è¡Œå¿…å®šæ˜¯æ— åºçš„. å½“æˆ‘ä»¬åœ¨ç¬¬ä¸‰ä¸ªä»»åŠ¡ä¹‹ååŠ å…¥`dispatch_barrier_async`ä»»åŠ¡, é‚£ä¹ˆè¿™äº”ä¸ªä»»åŠ¡å°±è¢«åˆ†å‰²æˆä¸¤éƒ¨åˆ†, å‰ä¸‰æ¬¡æ— åºæ‰§è¡Œ, ç„¶åæ‰§è¡Œ`dispatch_barrier_async`ä»»åŠ¡, ç„¶åå†æ— åºæ‰§è¡Œåä¸¤æ¬¡ä»»åŠ¡. æ³¨æ„**æ­¤å¤„çš„é˜Ÿåˆ—åªèƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„å¹¶è¡Œé˜Ÿåˆ—, ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—ä¸è¡Œ**

```
- (void)barrierTest {
    
    //æ­¤å¤„çš„é˜Ÿåˆ—åªèƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„å¹¶è¡Œé˜Ÿåˆ—, ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—ä¸è¡Œ
    dispatch_queue_t queue = dispatch_queue_create("barrierTest", DISPATCH_QUEUE_CONCURRENT);
    
    dispatch_async(queue, ^{
        NSLog(@"1");
    });
    dispatch_async(queue, ^{
        NSLog(@"2");
    });
    dispatch_async(queue, ^{
        NSLog(@"3");
    });
    dispatch_barrier_async(queue, ^{
        sleep(3);
        NSLog(@"æ’å…¥æ‰§è¡Œ");
    });
    dispatch_async(queue, ^{
        NSLog(@"4");
    });
    dispatch_async(queue, ^{
        NSLog(@"5");
    });
}
```

### GCDä¿¡å·é‡(dispatch_semaphore_t)

æˆ‘ä»¬ä»¥è¿™ä¸ªä½¿ç”¨åœºæ™¯ä¸ºä¾‹, æ¥è¯´æ˜ä¸€ä¸‹, ä¸è€ƒè™‘é¡ºåº å°†æ‰€æœ‰çš„æ•°æ®æ·»åŠ åˆ°ç©ºæ•°ç»„ä¸­å», æˆ‘ä»¬å¯èƒ½ä¼šè¿™ä¹ˆå®ç°:

```
- (void)dispatchSemaphoreDemo {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    NSMutableArray *array = [NSMutableArray array];
    for (int i = 0; i < 100000; i++) {
        dispatch_async(queue, ^{
            NSLog(@"%@", [NSThread currentThread]);
            [array addObject:@(i)];
        });
    }
}
```

å› ä¸ºæ˜¯å¹¶è¡Œé˜Ÿåˆ—, å¼‚æ­¥ä»»åŠ¡, æ‰€ä»¥ä¼šå¼€å¤§é‡çš„çº¿ç¨‹, å¹¶ä¸”è¿™äº›çº¿ç¨‹ä¼šä¿å­˜åœ¨å†…å­˜ä¸­,ç›¸å½“è€—è´¹èµ„æº, æœ€ç»ˆè¿è¡Œçš„ç»“æœå°±æ˜¯å´©æºƒ. é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¿¡å·é‡æ¥æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œ. `dispatch_semaphore_t`ç±»ä¼¼äºå•ä¸ªé˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°æ§åˆ¶æœºåˆ¶, æé«˜å¹¶è¡Œæ•ˆç‡çš„åŒæ—¶, ä¹Ÿå¯ä»¥é˜²æ­¢å¤ªå¤šçº¿ç¨‹çš„å¼€è¾Ÿå¯¹ç³»ç»Ÿé€ æˆå¤ªå¤§çš„è´Ÿæ‹…. æ”¹é€ ååº”è¯¥æ˜¯è¿™æ ·çš„: 

```
- (void)dispatchSemaphoreDemo {
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    NSMutableArray *array = [NSMutableArray array];
    
    //è®¾ç½®ä¿¡å·é‡åˆå§‹å€¼, å½“ä¿¡å·é‡ä¸º0æ—¶, æ‰€æœ‰ä»»åŠ¡ç­‰å¾…, ä¿¡å·é‡è¶Šå¤§, å…è®¸å¯å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡æ•°é‡è¶Šå¤š. å¹¶å‘çš„çº¿ç¨‹ç”±ç³»ç»Ÿè°ƒé…, ä¸ä¸€å®šä¸€ç›´æ˜¯åŒæ ·çš„ä¸¤æ¡, ä½†æ˜¯æœ€å¤šåªèƒ½åŒæ—¶å­˜åœ¨ä¸¤æ¡.
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(2);
    for (int i = 0; i < 100; i++) {
        
        //å½“ä¿¡å·é‡å¤§äºç­‰äºè®¾å®šçš„åˆå§‹å€¼æ—¶å°±ç»§ç»­æ‰§è¡Œ, å¦åˆ™ä¸€ç›´ç­‰å¾…
        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
        dispatch_async(queue, ^{
            //æ‰§è¡Œåˆ°è¿™é‡Œå°±ä»£è¡¨ä¿¡å·é‡å¤§äºç­‰äºè®¾å®šçš„åˆå§‹å€¼, æ‰€ä»¥åœ¨è¿™é‡Œä¿¡å·é‡è¦å‡1
            NSLog(@"%d+++++%@", i, [NSThread currentThread]);
            [array addObject:@(i)];
            //åˆ°è¿™é‡Œçš„æ—¶å€™, å› ä¸ºå¼‚æ­¥ä»»åŠ¡å·²ç»å°†è¦ç»“æŸ, è¦å°†ä¿¡å·é‡åŠ 1. å¦‚æœå‰é¢æœ‰ç­‰å¾…çš„çº¿ç¨‹, æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆæ‰§è¡Œ
            dispatch_semaphore_signal(semaphore);
        });
    }
}
```

### GCDå®šæ—¶å™¨

GCDå®ç°å®šæ—¶å™¨ä¸»è¦ç”¨åˆ°`dispatch_source_t`å‡½æ•°, è¯¥å‡½æ•°å®é™…æœ‰å¤šç§Type, `DISPATCH_SOURCE_TYPE_TIMER`æ˜¯å®šæ—¶å™¨ç›¸å…³çš„ä»»åŠ¡, è¿˜æœ‰å…¶ä»–ç±»å‹çš„å¤„ç†äº‹ä»¶ç±»å‹. 

```
- (void)timerDemo {
    NSLog(@"%@", [NSThread currentThread]);
    //æŒ‡å®šDISPATCH_SOURCE_TYPE_TIMERç±»å‹, ä½œæˆDispatch Source
    
    //åœ¨å®šæ—¶å™¨ç»è¿‡æŒ‡å®šæ—¶é—´, æŠŠä»»åŠ¡è¿½åŠ åˆ°main queue
    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());
    
    //å®šæ—¶å™¨çš„ç›¸å…³è®¾ç½®, å°†å®šæ—¶å™¨è®¾ç½®ä¸º5så, ä¸æŒ‡å®šä¸ºé‡å¤, å…è®¸å»¶è¿Ÿ1s
    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, 5ull * NSEC_PER_SEC), DISPATCH_TIME_FOREVER, 1ull * NSEC_PER_SEC);
    
    //æŒ‡å®šå®šæ—¶å™¨æŒ‡å®šæ—¶é—´å†…æ‰§è¡Œçš„å¤„ç†
    dispatch_source_set_event_handler(timer, ^{
        NSLog(@"wake up");
        dispatch_source_cancel(timer);
    });
    
    //å–æ¶ˆå®šæ—¶å™¨æ—¶çš„å¤„ç†
    dispatch_source_set_cancel_handler(timer, ^{
        NSLog(@"canceled");
    });
    
    //å®šæ—¶å™¨å¯åŠ¨
    dispatch_resume(timer);
}
```

### NSOperationçš„ä¼˜å…ˆçº§

NSOperationQueueä¸­NSOperationå¯¹è±¡çš„æ‰§è¡Œæ–¹å¼æ˜¯æŒ‰ç…§FIFOçš„åŸåˆ™é¡ºåºæ‰§è¡Œ, ä½†æ˜¯å¦‚æœæˆ‘ä»¬è®¾ç½®äº†ä»»åŠ¡çš„ä¼˜å…ˆçº§, é‚£ä¹ˆç³»ç»Ÿå°±ä¼šç»™ä¼˜å…ˆçº§é«˜çš„ä¼˜å…ˆåˆ†é…èµ„æº. 

ä¼˜å…ˆçº§ä¸€å…±æœ‰è¿™å‡ ç§, ä»é«˜åˆ°ä½ä¾æ¬¡æ’åˆ—. 
```
typedef NS_ENUM(NSInteger, NSOperationQueuePriority) {
	NSOperationQueuePriorityVeryLow = -8L,
	NSOperationQueuePriorityLow = -4L,
	NSOperationQueuePriorityNormal = 0,
	NSOperationQueuePriorityHigh = 4,
	NSOperationQueuePriorityVeryHigh = 8
};
```

ç¤ºä¾‹ä»£ç å¦‚ä¸‹, ä¸‰ä¸ªä»»åŠ¡è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å», è¿™ä¸‰ä¸ªä»»åŠ¡åˆ†åˆ«åœ¨ä¸‰ä¸ªçº¿ç¨‹, äº’ä¸å¹²æ‰°, ç±»ä¼¼äºGCDçš„å¼‚æ­¥å¹¶è¡Œæ¨¡å¼, å¦‚æœæˆ‘ä»¬è®¾ç½®`invocationOper.queuePriority = NSOperationQueuePriorityVeryLow`ç†è®ºä¸Š, `invocationOper`ä»»åŠ¡ä¼šåœ¨æœ€åæ‰§è¡Œ, ä½†æ˜¯æˆ‘ä»¬å‘ç°å¹¶æ²¡æœ‰, é‚£æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è®¾ç½®æœ€å¤§å¹¶å‘æ•°çš„åŸå› , æˆ‘çŒœæµ‹ç³»ç»Ÿå¯èƒ½æ˜¯åšäº†æŸäº›é™åˆ¶, è™½ç„¶æ˜¯æ–°å¼€äº†çº¿ç¨‹, ä½†æ˜¯ç”±äºæœ€å¤§å¹¶å‘æ•°å°äºç­‰äº1å®é™…è¿˜æ˜¯æŒ‰ç…§FIFOé¡ºåºæ‰§è¡Œ, **æ‰€ä»¥æ³¨æ„ä¸€å®šè¦è®¾ç½®æœ€å¤§å¹¶å‘æ•°**.

```
//æŠŠæ³¨é‡Šæ‰“å¼€å°±å¯ä»¥çœ‹åˆ°æƒ³è¦çš„æ•ˆæœ
- (void)NSOperationQueueRun {
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    //queue.maxConcurrentOperationCount = 3;
    NSInvocationOperation *invocationOper = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(invocationOperSel) object:nil];
    //invocationOper.queuePriority = NSOperationQueuePriorityVeryLow;
    [queue addOperation:invocationOper];
    NSBlockOperation *blockOper = [NSBlockOperation blockOperationWithBlock:^{
        NSLog(@"NSBlockOperationRun_%@", [NSThread currentThread]);
    }];
    [queue addOperation:blockOper];
    [queue addOperationWithBlock:^{
        NSLog(@"QUEUEBlockOperationRun_%@", [NSThread currentThread]);
    }];
}

- (void)invocationOperSel {
    NSLog(@"NSInvocationOperationRun_%@", [NSThread currentThread]);
}
```

### NSOperationçš„ä¾èµ–å…³ç³»

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—, åˆ†åˆ«åˆ›å»ºè¦æ‰§è¡Œçš„ä»»åŠ¡, **åœ¨æŠŠè¦æ‰§è¡Œçš„ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å»ä¹‹å‰, é€šè¿‡`addDependency`æ¥å»ºç«‹ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»**. å¦‚æœæˆ‘ä»¬æ²¡æœ‰è®¾ç½®ä¾èµ–çš„è¯, å¦‚æœè®¾ç½®çš„å¹¶å‘æ•°å¤§äº1,  é‚£ä¹ˆ`blockOper_1`å’Œ``blockOper_2`çš„æ‰§è¡Œé¡ºåºæ˜¯éšæœºçš„. å¯æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œ`[blockOper_1 addDependency:blockOper_2]`æ—¶, å°±ç»™ä¸¤ä¸ªä»»åŠ¡æ·»åŠ äº†ä¾èµ–å…³ç³», `blockOper_1`æ°¸è¿œåªä¼šåœ¨`blockOper_2`åæ‰§è¡Œ. å³ä½¿æˆ‘ä»¬ç»™`blockOper_1`è®¾ç½®äº†æœ€é«˜çš„ä¼˜å…ˆçº§, å› ä¸º**ä¾èµ–çš„ä¼˜å…ˆçº§è¦é«˜äº`queuePriority`**. 

```
- (void)NSOperationQueueRun2 {
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
//    queue.maxConcurrentOperationCount = 2;
    NSBlockOperation *blockOper_1 = [NSBlockOperation blockOperationWithBlock:^{
        NSLog(@"blockOper_1_%@_%@",@(1),[NSThread currentThread]);
    }];
    
    NSBlockOperation *blockOper_2 = [NSBlockOperation blockOperationWithBlock:^{
        NSLog(@"blockOper_2_%@_%@",@(2),[NSThread currentThread]);
    }];
    
//    blockOper_1.queuePriority = NSOperationQueuePriorityVeryHigh;
    [blockOper_1 addDependency:blockOper_2];
    [queue addOperation:blockOper_1];
    [queue addOperation:blockOper_2];
}
```

## å¸¸è§ä½¿ç”¨æ¡ˆåˆ—åˆ†æ

### æ¡ˆä¾‹ä¸€

```
- (void)case1 {
    NSLog(@"ä»»åŠ¡ä¸€ - %@", [NSThread currentThread]);
    dispatch_sync(dispatch_get_main_queue(), ^{
        NSLog(@"åŒæ­¥ä»»åŠ¡ - %@",[NSThread currentThread]);
    });
    NSLog(@"ä»»åŠ¡äºŒ - %@", [NSThread currentThread]);
}

```

ä»¥ä¸Š`- (void)case1`é»˜è®¤åœ¨å½“å‰çº¿ç¨‹(ä¸»çº¿ç¨‹)æ‰§è¡Œ,  é¦–å…ˆæ‰§è¡Œ"ä»»åŠ¡ä¸€". ç„¶å`dispatch_sync`é˜»å¡å½“å‰çº¿ç¨‹(ä¸»çº¿ç¨‹), ç”±äºä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—, ä»»åŠ¡ä¸èƒ½å¹¶å‘æ‰§è¡Œ, åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œ. åˆå› ä¸º**"åŒæ­¥ä»»åŠ¡"åå…¥åˆ—, æŒ‰ç…§FIFOåŸåˆ™, å¿…é¡»ç­‰åˆ°`- (void)case1`æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ‰§è¡Œ**, ä½†æ˜¯`- (void)case1`ä¸­çš„"ä»»åŠ¡äºŒ"åˆåœ¨ç­‰ç€"åŒæ­¥ä»»åŠ¡"æ‰§è¡Œå®Œæ¯•æ‰èƒ½æ‰§è¡Œ, è¿™æ ·å°±é€ æˆåŒä¸€é˜Ÿåˆ—ä¸­çš„ä¸¤ä¸ªä»»åŠ¡ç›¸äº’ç­‰å¾…, é€ æˆæ­»é”. 

![æ¡ˆä¾‹1](http://img.souche.com/f2e/5b1729532683ad164c061958d5248a66.png)

æœ‰ä¸¤ç§è§£å†³æ€è·¯, ä¸€æ˜¯ä¸ºå½“å‰é˜Ÿåˆ—æ‰©å®¹, è®©å®ƒå˜æˆå¹¶è¡Œé˜Ÿåˆ—, å°±ä¸ä¼šé€ æˆé˜»å¡. ç¬¬äºŒç§è§£å†³æ€è·¯æ˜¯æŠŠåŒæ­¥ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—ä¸­å», ä¸¤ä¸ªé˜Ÿåˆ—ä¹‹é—´ä¸å­˜åœ¨é˜»å¡å°±é¿å…äº†æ­»é”é—®é¢˜. 

### æ¡ˆä¾‹äºŒ

```
- (void)case2 {
    NSLog(@"1");
    //3ä¼šç­‰2ï¼Œå› ä¸º2åœ¨å…¨å±€å¹¶è¡Œé˜Ÿåˆ—é‡Œï¼Œä¸éœ€è¦ç­‰å¾…3ï¼Œè¿™æ ·2æ‰§è¡Œå®Œå›åˆ°ä¸»é˜Ÿåˆ—ï¼Œ3å°±å¼€å§‹æ‰§è¡Œ
    dispatch_sync(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{
        NSLog(@"2");
    });
    NSLog(@"3");
}
```

æ‰“å°é¡ºåºä¸€å®šä¸º1, 2, 3. 2æ–°å¼€é˜Ÿåˆ—, ä¸ä¼šé€ æˆæ­»é”. `case2`å’Œæ–°å¼€çš„blockä»»åŠ¡ä¹‹é—´æ²¡æœ‰é˜Ÿåˆ—çš„çº¦æŸ, ä½†æ˜¯ç”±äºæ˜¯åŒæ­¥ä»»åŠ¡,é˜»å¡çº¿ç¨‹, æ‰€ä»¥blockå…ˆæ‰§è¡Œ, æ‰§è¡Œå®Œæ¯•åå†å›åˆ°`case2`, æ¥ç€æ‰§è¡Œ.

![æ¡ˆä¾‹2](http://img.souche.com/f2e/27086c860f921209238d3f60c2f8722c.png)

### æ¡ˆä¾‹ä¸‰

```
- (void)case3 {
    dispatch_queue_t queue = dispatch_queue_create("com.demo.serialQueue", DISPATCH_QUEUE_SERIAL);
    NSLog(@"1"); // ä»»åŠ¡1
    dispatch_async(queue, ^{
        NSLog(@"2"); // ä»»åŠ¡2
        dispatch_sync(queue, ^{
            NSLog(@"3"); // ä»»åŠ¡3
        });
        NSLog(@"4"); // ä»»åŠ¡4
    });
    NSLog(@"5"); // ä»»åŠ¡5
}
```

æ§åˆ¶å°è¾“å‡º1, 5, 2. (5, 2çš„é¡ºåºä¸ä¸€å®š). å¯ä»¥è‚¯å®š, ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—. é¦–å…ˆæ‰§è¡Œä»»åŠ¡1, æ¥ä¸‹æ¥æœ‰ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡, æ–°å¼€è¾Ÿçº¿ç¨‹(å°†ä»»åŠ¡2, åŒæ­¥çº¿ç¨‹, ä»»åŠ¡4åŠ å…¥æ–°çº¿ç¨‹). å› ä¸ºæ˜¯å¼‚æ­¥çº¿ç¨‹, ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡5ä¸ç”¨ç­‰å¾…, æ‰€ä»¥ 2 å’Œ 5 çš„è¾“å‡ºé¡ºåºä¸å®š. ä»»åŠ¡2æ‰§è¡Œå®Œå, é‡åˆ°åŒæ­¥ä»»åŠ¡, å› ä¸ºæ˜¯åœ¨ä¸²è¡Œé˜Ÿåˆ—, æ‰€ä»¥ä¼šé˜»å¡å½“å‰çº¿ç¨‹, ä»»åŠ¡3æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œä»»åŠ¡4. ä½†æ˜¯ä»»åŠ¡4æ¯”ä»»åŠ¡3æ—©åŠ å…¥é˜Ÿåˆ—, æ ¹æ®FIFOåŸåˆ™, ä»»åŠ¡3è¦ç­‰å¾…ä»»åŠ¡4æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œ. ä»»åŠ¡3å’Œä»»åŠ¡4ç›¸äº’ç­‰å¾…é€ æˆæ­»é”. 

![æ¡ˆä¾‹ä¸‰å›¾ç‰‡](http://img.souche.com/f2e/9c13eaeac28f7fe7105af2feb878d5ef.png)

### æ¡ˆä¾‹å››

```
- (void)case4 {
    NSLog(@"1"); // ä»»åŠ¡1
    dispatch_async(dispatch_get_global_queue(0, 0), ^{
        NSLog(@"2"); // ä»»åŠ¡2
        dispatch_sync(dispatch_get_main_queue(), ^{
            NSLog(@"3"); // ä»»åŠ¡3
        });
        NSLog(@"4"); // ä»»åŠ¡4
    });
    NSLog(@"5"); // ä»»åŠ¡5
}
```

æ‰“å°ç»“æœæ˜¯: 1, 5, 2, 3, 4.(2, 5çš„é¡ºåºä¸å®š). é¦–å…ˆåœ¨ä¸»çº¿ç¨‹ä¸­æœ‰ä¸‰ä¸ªä»»åŠ¡, åˆ†åˆ«æ˜¯ä»»åŠ¡1, å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡, ä»»åŠ¡5. å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡ä¸­åˆæœ‰ä¸‰ä¸ªä»»åŠ¡, åˆ†åˆ«æ˜¯ä»»åŠ¡2, å¼‚æ­¥ä»»åŠ¡, ä»»åŠ¡4.  

æ‰€ä»¥å…ˆæ‰“å°1, ç„¶åæŠŠå¼‚æ­¥ä»»åŠ¡åŠ å…¥å…¨éƒ¨å¹¶è¡Œé˜Ÿåˆ—, ç”±äºæ˜¯å¼‚æ­¥ä»»åŠ¡æ–°å¼€è¾Ÿçº¿ç¨‹, ä¸é˜»å¡ä¸»çº¿ç¨‹, 5ä¸ç”¨ç­‰å¾…. æ‰€ä»¥2, 5é¡ºåºä¸å®š. ç„¶åå†åˆ†æå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„å¼‚æ­¥ä»»åŠ¡, ä»»åŠ¡2æ‰§è¡Œåé‡åˆ°åŒæ­¥ä»»åŠ¡, åŒæ­¥ä»»åŠ¡è¢«åŠ å…¥åˆ°ä¸»çº¿ç¨‹(å› ä¸ºå‰é¢å·²ç»è¢«åŠ è¿‡3ä¸ªä»»åŠ¡, æ‰€ä»¥è¯¥ä»»åŠ¡åœ¨ä»»åŠ¡5åé¢). å› ä¸ºæ˜¯åŒæ­¥, é˜»å¡ä¸»çº¿ç¨‹, æ‰€ä»¥4ä¸€å®šåœ¨3åé¢. 

![æ¡ˆä¾‹å››](http://img.souche.com/f2e/43a48f9de1c0bb336215543157ad875b.png
)

### æ¡ˆä¾‹äº”

```
- (void)case5 {
    dispatch_async(dispatch_get_global_queue(0, 0), ^{
        NSLog(@"1"); // ä»»åŠ¡1
        dispatch_sync(dispatch_get_main_queue(), ^{
            NSLog(@"2"); // ä»»åŠ¡2
        });
        NSLog(@"3"); // ä»»åŠ¡3
    });
    NSLog(@"4"); // ä»»åŠ¡4
    while (1) {
    }
    NSLog(@"5"); // ä»»åŠ¡5
}

```

æ‰“å°ç»“æœæ˜¯: 1, 4(é¡ºåºä¸å®š). é¦–å…ˆä¸»çº¿ç¨‹ä¸­æœ‰å››ä¸ªä»»åŠ¡, åˆ†åˆ«æ˜¯å…¨å±€å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡, ä»»åŠ¡4, æ­»å¾ªç¯, ä»»åŠ¡5. å…¨å±€å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡ä¸­åˆæœ‰ä¸‰ä¸ªä»»åŠ¡, åˆ†åˆ«æ˜¯ä»»åŠ¡1, ä¸»çº¿ç¨‹çš„åŒæ­¥ä»»åŠ¡(ä»»åŠ¡2), ä»»åŠ¡3. 

ç”±äºæ˜¯å¼‚æ­¥ä»»åŠ¡, ä¸é˜»å¡ä¸»çº¿ç¨‹, æ‰€ä»¥å…¨å±€å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œé¡ºåºå’Œä»»åŠ¡4ä¸å®š, å…¨å±€å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥ä»»åŠ¡åˆæ˜¯å…ˆæ‰§è¡Œä»»åŠ¡1, æ‰€ä»¥ä»»åŠ¡1å’Œä»»åŠ¡4çš„é¡ºåºä¸å®š. å½“ä»»åŠ¡4æ‰§è¡Œå®Œå, è¿›å…¥æ­»å¾ªç¯, ä¸»çº¿ç¨‹è¢«é˜»å¡. ç”±äºåŒæ­¥ä»»åŠ¡(ä»»åŠ¡2)æ˜¯è¢«åŠ åœ¨ä¸»çº¿ç¨‹ä¸­, ä½†æ˜¯æ­¤æ—¶ä¸»çº¿ç¨‹å·²è¢«é˜»å¡, æ‰€ä»¥2ä¸ä¼šè¢«æ‰§è¡Œ. ä»»åŠ¡3åˆæ˜¯åœ¨ä»»åŠ¡2åè¢«åŠ å…¥é˜Ÿåˆ—, ä»»åŠ¡2æ˜¯åŒæ­¥ä»»åŠ¡, æ‰€ä»¥ä»»åŠ¡3è¦ç­‰å¾…ä»»åŠ¡2å®Œæˆæ‰æ‰§è¡Œ. æ‰€ä»¥ä»»åŠ¡2, ä»»åŠ¡3éƒ½ä¸ä¼šæ‰§è¡Œ. ä»»åŠ¡5åœ¨æ­»å¾ªç¯åæ‰§è¡Œ, æ‰€ä»¥ä»»åŠ¡5æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ. å¦‚æœæ²¡æœ‰æ­»å¾ªç¯, ä»»åŠ¡2è‚¯å®šåœ¨ä»»åŠ¡ååé¢, ä»»åŠ¡3è‚¯å®šåœ¨ä»»åŠ¡2åé¢. 

![æ¡ˆä¾‹äº”](http://img.souche.com/f2e/0d108cba7a737b62e2f5e1be402bc5d0.png)

-------
å‚è€ƒèµ„æ–™:

1.[å…³äºiOSå¤šçº¿ç¨‹, ä½ çœ‹æˆ‘å°±å¤Ÿäº†](http://www.cocoachina.com/ios/20150731/12819.html)

2.[iOSå¤šçº¿ç¨‹ç¼–ç¨‹æ€»ç»“](https://bestswifter.com/multithreadconclusion/)

3.[å…³äºiOSå¤šçº¿ç¨‹, æˆ‘è¯´, ä½ å¬, æ²¡å‡†ä½ å°±æ‡‚äº†](http://www.jianshu.com/p/51fd1362249e)

4.[æ·±å…¥ç†è§£ GCD](http://www.jianshu.com/p/06a18323d9d2)

5.[å…³äº iOS å¤šçº¿ç¨‹, éƒ½åœ¨è¿™é‡Œäº†](http://www.jianshu.com/p/6a6722f12fe3)

6.[è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«](http://blog.csdn.net/mxsgoden/article/details/8821936)

7.[å¹¶å‘å’Œå¹¶è¡Œ](https://laike9m.com/blog/huan-zai-yi-huo-bing-fa-he-bing-xing,61/)



















